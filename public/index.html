<html>
<head>
  <script src="/js/face-api.min.js"></script>
  <style>
    #overlay, .overlay {
     position: absolute;
     top: 0;
     left: 0;
    }
#container {
	margin: 0px auto;
	width: 500px;
	height: 375px;
	border: 10px #333 solid;
}
#videoElement {
	width: 500px;
	height: 375px;
	background-color: #666;
}
  </style>
</head>
 
<body>
  </div>
  <div style="position: relative" class="margin">
    <img id="inputImg" src="/pics/Poonunuch.jpg" style="max-width: 800px;" />
    <canvas id="overlay" />
  </div>

  <script>
    async function loadModels() {
      const MODEL_URL = '/models'
      await faceapi.loadSsdMobilenetv1Model(MODEL_URL)
      await faceapi.loadFaceLandmarkModel(MODEL_URL)
      await faceapi.loadFaceRecognitionModel(MODEL_URL)
      var img = document.getElementById("inputImg");
      var canvas = document.getElementById('overlay');
   
      
      let fullFaceDescriptions = await faceapi.detectAllFaces(img).withFaceLandmarks().withFaceDescriptors()
      console.log(fullFaceDescriptions)
      faceapi.matchDimensions(canvas, img)

      faceapi.draw.drawDetections(canvas, fullFaceDescriptions)
      faceapi.draw.drawFaceLandmarks(canvas, fullFaceDescriptions)
     
      const labels = ['tanakit','Poonunuch']
      const labeledFaceDescriptors = await Promise.all(
        labels.map(async label => {
        const imgUrl = `/pics/${label}.jpg`
        const img = await faceapi.fetchImage(imgUrl)
        const fullFaceDescription = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor()
        if (!fullFaceDescription) {
          throw new Error(`no faces detected for ${label}`)
        }
        const faceDescriptors = [fullFaceDescription.descriptor]
        return new faceapi.LabeledFaceDescriptors(label, faceDescriptors)
        })
      )

      // 0.6 is a good distance threshold value to judge
      // whether the descriptors match or not
      const maxDescriptorDistance = 0.6
      const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, maxDescriptorDistance)
      const results = fullFaceDescriptions.map(fd => faceMatcher.findBestMatch(fd.descriptor))

      results.forEach((bestMatch, i) => {
        const box = fullFaceDescriptions[i].detection.box
        const text = bestMatch.toString()
         console.log(text)
        const drawBox = new faceapi.draw.DrawBox(box, { label: text })
        drawBox.draw(canvas)
      })
      
    }
    loadModels()
    
    async function test() {
      // const input = document.getElementById('myImage')
      // let fullFaceDescriptions = await faceapi.detectAllFaces(input).withFaceLandmarks().withFaceDescriptors()
    }

  </script>

</body>
</html>
